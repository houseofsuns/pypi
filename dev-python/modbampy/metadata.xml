<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription>![Oxford Nanopore Technologies logo](https://github.com/epi2me-labs/modbam2bed/raw/master/images/ONT_logo_590x106.png)We have a new bioinformatic resource that replaces the functionality of this project! See our new repository here: [modkit](https://github.com/nanoporetech/modkit/).This repository is now unsupported and we do not recommend its use. Please contact Oxford Nanopore: support@nanoporetech.com for help with your application if it is not possible to upgrade.******************Modified-base BAM to bedMethyl------------------------------A program to aggregate modified base counts stored in a[modified-base BAM](https://samtools.github.io/hts-specs/SAMtags.pdf) (Section 2.1) file to a [bedMethyl](https://www.encodeproject.org/data-standards/wgbs/) file.A Python module is also available to obtain modified base informationfrom BAM files in a convenient form. It is envisaged that this will eventuallybe replaced by an implementation in [pysam](https://pysam.readthedocs.io/en/latest/index.html).### InstallationThe program is available from our conda channel, so can be installed with:    mamba create -n modbam2bed -c bioconda -c conda-forge -c epi2melabs modbam2bedPackages are available for both Linux and MacOS.Alternatively to install from the source code, clone the repository and then use make:    git clone --recursive https://github.com/epi2me-labs/modbam2bed.git    make modbam2bed    ./modbam2bedSee the Makefile for more information. The code has been tested on MacOS (withdependencies from brew) and on Ubuntu 18.04 and 20.04.### UsageThe code requires aligned reads with the `Mm` and `Ml` tags (`MM` and `ML` also supported),and the reference sequence used for alignment.The below is a snapshot of the command-line interface; it may not be up-to-date, pleaserefer to the program `--help` option for the most accurate guidance.```Usage: modbam2bed [OPTION...] &lt;reference.fasta&gt; &lt;reads.bam&gt; [&lt;reads.bam&gt; ...]modbam2bed -- summarise one or more BAM with modified base tags to bedMethyl.  General options:      --aggregate            Output additional aggregated (across strand)                             counts, requires --cpg or --chg.      --combine              Create output with combined modified counts: i.e.                             alternative modified bases within the same family                             (same canonical base) are included.  -c, --pileup               Output (full) raw base counts rather than BED                             file.  -e, --extended             Output extended bedMethyl including counts of                             canonical, modified, and filtered bases (in that                             order).  -m, --mod_base=BASE        Modified base of interest, one of: 5mC, 5hmC, 5fC,                             5caC, 5hmU, 5fU, 5caU, 6mA, 5oxoG, Xao. (Or modA,                             modC, modG, modT, modU, modN for generic modified                             base).  -p, --prefix=PREFIX        Output file prefix. Only used when multiple output                             filters are given.  -r, --region=chr:start-end Genomic region to process.  -t, --threads=THREADS      Number of threads for BAM processing. Base filtering options:  -a, --canon_threshold=THRESHOLD                             Deprecated. The option will be removed in a future                             version. Please use --threshold.  -b, --mod_threshold=THRESHOLD   Deprecated. The option will be removed in a                             future version. Please use --threshold.      --chg                  Output records filtered to CHG sites.      --chh                  Output records filtered to CHH sites.      --cpg                  Output records filtered to CpG sites.  -f, --threshold=THRESHOLD  Bases with a call probability &lt; THRESHOLD are                             filtered from results (default 0.66).  -k, --mask                 Respect soft-masking in reference file. Read filtering options:  -d, --max_depth=DEPTH      Max. per-file depth; avoids excessive memory                             usage.  -g, --read_group=RG        Only process reads from given read group.      --haplotype=VAL        Only process reads from a given haplotype.                             Equivalent to --tag_name HP --tag_value VAL.      --tag_name=TN          Only process reads with a given tag (see                             --tag_value).      --tag_value=VAL        Only process reads with a given tag value.  -?, --help                 Give this help list      --usage                Give a short usage message  -V, --version              Print program versionMandatory or optional arguments to long options are also mandatory or optionalfor any corresponding short options.```### Method and output formatOxford Nanopore Technogies' sequencing chemistries and basecallers can detectany number of modified bases. Compared to traditional methods which force afalse dichoctomy between say cytosine and 5-methylcytosine, this rich biologyneeds to be remembered when interpreting modified base calls.The htslib pileup API is used to create a matrix of per-strand base countsincluding substitutions, modified bases and deletions. Inserted bases are notcounted. Bases of an abiguous nature (refered to as &quot;filtered&quot; below), asdefined by the filter threshold probabilities option `-b` are masked and used(along with substitutions and deletions) in the definition of the &quot;score&quot;(column 5) and &quot;coverage&quot; (column 10) entries of the bedMethyl file.In the case of `?`-style `MM` subtags, where a lack of a recorded call shouldnot be taken as implying a canonical-base call, the &quot;no call&quot; count is incremented.The &quot;no call&quot; count is used in the calculation of &quot;coverage&quot; and also the denominatorof &quot;score&quot;.In summary, a base is determined as being either &quot;canonical&quot;, &quot;modified&quot;, &quot;filtered&quot;,or &quot;no call&quot;. The final output includes a modification frequency and score andcoverage information in order to assess the reliability of the frequency.**Call filtering**To determine the base present at a locus in a read, the query base in theBAM record is examined along with the modified base information. A &quot;canonical&quot;base probability is calculated as `1 - sum(P_mod)`, with `P_mod` beingthe set of probabilities associated with all the modifications enumeratedin the BAM record. The base form with largest probability is taken as thebase present subject to the user-specified threshold. If the probabilityis below the threshold the call is masked and contributes to the &quot;filtered&quot;base count rather than the &quot;canonical&quot; or &quot;modified&quot; counts.**Special Handling of alternative modified bases (`--combine` option)**To intepret the case of multiple modifications being listed inthe BAM, `modbam2bed` can operate in two modes:* *default*: alternative modified bases in the same family as the requested  modification are counted separatedly as &quot;other&quot; --- neither in  the &quot;canonical&quot; count of the &quot;modified&quot; count.* `--combine`: alternative modified bases are lumped together into the   &quot;modified&quot; count and ultimately into a single modification frequency.***A particular case where `--combine` is useful is when comparing to the result of bisulfite sequencing.*****Output format**&gt; The description of the [bedMethyl](https://www.encodeproject.org/data-standards/wgbs/)&gt; format on the ENCODE project website is rather loose. The definitions below are chosen pragmatically.The table below describes precisely the entries in each column of the output BEDfile. Columns seven to nine inclusive are included for compatibility with the BEDfile specification, the values written are fixed and no meaning should be derivedfrom them. Columns 5, 10, and 11 are defined in terms of counts of observedbases to agree with reasonable interpretations of the bedMethyl specifications: * N&lt;sub&gt;canon&lt;/sub&gt; - canonical (unmodified) base count, (contigent on the use of `--combine`, see above.) * N&lt;sub&gt;mod&lt;/sub&gt; - modified base count. * N&lt;sub&gt;filt&lt;/sub&gt; - count of bases where read does not contain a substitution or deletion   with respect to the reference, but the modification status is ambiguous: these bases   were filtered from the calculation of the modification frequency. * N&lt;sub&gt;sub&lt;/sub&gt; - count of reads with a substitution with respect to the reference. * N&lt;sub&gt;del&lt;/sub&gt; - count of reads with a deletion with respect to the reference. * N&lt;sub&gt;no call&lt;/sub&gt; - counts of reads with an absent modification call (but not a substitution or deletion). * N&lt;sub&gt;alt mod&lt;/sub&gt; - counts of reads with and alternative modification call (but not a substitution or deletion).Since these interpretations may differ from other tools an extended output isavailable (enabled with the `-e` option) which includes three additional columnswith verbatim base counts.| column | description                                                                                                                                                                                                                                                                  ||--------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|| 1      | reference sequence name                                                                                                                                                                                                                                                      || 2      | 0-based start position                                                                                                                                                                                                                                                       || 3      | 0-based exclusive end position (invariably start + 1)                                                                                                                                                                                                                        || 4      | Abbreviated name of modified-base examined                                                                                                                                                                                                                                   || 5      | &quot;Score&quot; 1000 * (N&lt;sub&gt;mod&lt;/sub&gt; + N&lt;sub&gt;canon&lt;/sub&gt;) / (N&lt;sub&gt;mod&lt;/sub&gt; + N&lt;sub&gt;canon&lt;/sub&gt; + N&lt;sub&gt;no call&lt;/sub&gt; + N&lt;sub&gt;alt mod&lt;/sub&gt; + N&lt;sub&gt;filt&lt;/sub&gt; + N&lt;sub&gt;sub&lt;/sub&gt; + N&lt;sub&gt;del&lt;/sub&gt;). The quantity reflects the extent to which the calculated modification frequency in Column 11 is confounded by the alternative calls. The denominator here is the total read coverage as given in Column 10. || 6      | Strand (of reference sequence). Forward &quot;+&quot;, or reverse &quot;-&quot;.                                                                                                                                                                                                                 || 7-9    | Ignore, included simply for compatibility.                                                                                                                                                                                                                                   || 10     | Read coverage at reference position including all canonical, modified, undecided (no calls and filtered), substitutions from reference, and deletions.  N&lt;sub&gt;mod&lt;/sub&gt; + N&lt;sub&gt;canon&lt;/sub&gt; + N&lt;sub&gt;no call&lt;/sub&gt; + N&lt;sub&gt;alt mod&lt;/sub&gt; + N&lt;sub&gt;filt&lt;/sub&gt; + N&lt;sub&gt;sub&lt;/sub&gt; + N&lt;sub&gt;del&lt;/sub&gt;                                        || 11     | Percentage of modified bases, as a proportion of canonical and modified (excluding no calls, filtered, substitutions, and deletions).  100 \* N&lt;sub&gt;mod&lt;/sub&gt; / (N&lt;sub&gt;mod&lt;/sub&gt;  + N&lt;sub&gt;alt mod&lt;/sub&gt; + N&lt;sub&gt;canon&lt;/sub&gt;)                                                                                       || 12\*    | N&lt;sub&gt;canon&lt;/sub&gt;                                                                                                                                                                                                                                                            || 13\*    | N&lt;sub&gt;mod&lt;/sub&gt;                                                                                                                                                                                                                                                         || 14\*    | N&lt;sub&gt;filt&lt;/sub&gt; those bases with a modification probability falling between given thresholds.                                                                                                                                                                           || 15\*    | N&lt;sub&gt;no call&lt;/sub&gt; those bases for which the query base was the correct canonical base for the modified base being considered, but no call was made (see the definition of the `.` and `?` flags in the SAM tag specification).                                                                                                                                                                           || 16\*    | N&lt;sub&gt;alt mod&lt;/sub&gt; those bases for which the query base was the correct canonical base for the modified base being considered, but and alternative modification was present.                                                                                                                                                                           |\* Included in extended output only.### LimitationsThe code has not been developed extensively and currently has some limitations: * Support for motif filtering is limited to CpG, CHG, and CHH, sites. Without   this filtering enabled all reference positions that are the canonical base   (on forward or reverse strand) equivalent to the modified base under   consideration are reported. * Insertion columns are completely ignored for simplicitly (and avoid   any heuristics). * Second strand `MM` subtags (i.e. `MM:C-m` as compared with `MM:C+m`)   are not supported. These are not typically used so shouldn't affect most users.   If such a tag is detected and warning will be thrown and the tag ignored. These tags   do come in to play for duplex basecalls.### Python packageA Python package is available on [PyPI](https://pypi.org/project/modbampy/) whichcontains basic functionality for parsing BAM files with modified-base information.It is envisaged that this will eventually be replaced by an implementation in[pysam](https://pysam.readthedocs.io/en/latest/index.html). As such the interfaceis supplements but does not integrate or replace pysam.The package can be installed with:```pip install modbampy```The package contains simply to modes of use. Firstly an interface to iterateover reads in a BAM file and report modification sites:```from modbampy import ModBamwith ModBam(args.bam) as bam:    for read in bam.reads(args.chrom, args.start, args.end):        for pos_mod in read.mod_sites:            print(*pos_mod)```Each line of the above reports the* read_id,* reference position,* query (read) position,* reference strand (+ or -),* modification strand (0 or 1, as defined in the HTSlib tag specification. This is invariable 0),* canonical base associated with modification,* modified base,* modified-base score (scaled to 0-255).A second method is provided which mimics the couting procedure implemented in`modbam2bed`:```from modbampy import ModBamwith ModBam(args.bam) as bam:    positions, counts = bam.pileup(        args.chrom, args.start, args.end        low_threshold=0.33, high_threshold=0.66, mod_base=&quot;m&quot;)```The result is two [numpy](https://numpy.org/) arrays. The first indicates the referencepositions associated with the counts in the second array. Each row of the second array(`counts` above) enumerates the observed counts of bases in the order:    a c g t A C G T d D m M f F n Nwhere uppercase letters refer to bases on the forward strand, lowercase lettersrelate to the reverse strand:* A, C, G, T are the usual DNA bases,* D indicates deletion counts,* M modified base counts,* F filtered counts - bases in reads with a modified-base record but which were filtered  according to the thresholds provided.* N no call base counts.**Extras**The read iterator API also contains a minimal set of functionality mirroring properties of alignments available from pysam. See the [code](https://github.com/epi2me-labs/modbam2bed/blob/master/modbampy/__init__.py)for further details.### AcknowledgementsWe thank [jkbonfield](https://github.com/jkbonfield) for developing the modified basefunctionality into the htslib pileup API, and [Jared Simpson](https://github.com/jts)for testing and comparison to his independently developed code.### Help**Licence and Copyright**Â© 2021- Oxford Nanopore Technologies Ltd.`modbam2bed` is distributed under the terms of the Mozilla Public License 2.0.**Research Release**Research releases are provided as technology demonstrators to provide earlyaccess to features or stimulate Community development of tools. Support forthis software will be minimal and is only provided directly by the developers.Feature requests, improvements, and discussions are welcome and can beimplemented by forking and pull requests. However much as we wouldlike to rectify every issue and piece of feedback users may have, thedevelopers may have limited resource for support of this software. Researchreleases may be unstable and subject to rapid iteration by Oxford NanoporeTechnologies.</longdescription>
</pkgmetadata>