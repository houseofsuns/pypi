<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># hicstuff[![PyPI version](https://badge.fury.io/py/hicstuff.svg)](https://badge.fury.io/py/hicstuff)![PyPI - Python Version](https://img.shields.io/pypi/pyversions/hicstuff.svg)[![install with bioconda](https://img.shields.io/badge/install%20with-bioconda-brightgreen.svg?style=flat)](http://bioconda.github.io/recipes/hicstuff/README.html)[![Build Status](https://github.com/koszullab/hicstuff/actions/workflows/build.yml/badge.svg?branch=master)](https://github.com/koszullab/hicstuff/actions/workflows/build.yml)[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.2620608.svg)](https://doi.org/10.5281/zenodo.2620608)[![codecov](https://codecov.io/gh/koszullab/hicstuff/branch/master/graph/badge.svg)](https://codecov.io/gh/koszullab/hicstuff)[![Read the docs](https://readthedocs.org/projects/hicstuff/badge)](https://hicstuff.readthedocs.io)[![Binder](https://mybinder.org/badge_logo.svg)](https://mybinder.org/v2/gh/koszullab/hicstuff/master?filepath=doc%2Fnotebooks%2Fdemo_api.ipynb)[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/ambv/black)A lightweight library that generates and handles Hi-C contact maps in either cooler-compatible 2Dbedgraph or [instaGRAAL](https://github.com/koszullab/instaGRAAL) format. It is essentially a merge of the [yahcp](https://github.com/baudrly/yahcp) pipeline, the [hicstuff](https://github.com/baudrly/hicstuff) library and extra features illustrated in the [3C tutorial](https://github.com/axelcournac/3C_tutorial) and the [DADE pipeline](https://github.com/scovit/dade), all packaged together for extra convenience.The goal is to make generation and manipulation of Hi-C matrices as simple as possible and work for any organism.## Table of contents* [Installation](#installation)  * [pip](#pip)  * [conda](#conda)  * [docker](#docker)* [Usage](#usage)  * [Full pipeline](#full-pipeline)  * [Individual components](#individual-components)* [Library](#library)* [Connecting the modules](#connecting-the-modules)* [File formats](#file-formats)* [Contributing](#contributing)## Installation### pipTo install a stable version:```shpip3 install -U hicstuff```or, for the latest development version:```sh    pip3 install -e git+https://github.com/koszullab/hicstuff.git@master#egg=hicstuff````bowtie2`, `bwa` and/or `minimap2` as well as `samtools` are required by the `pipeline` command.You can install them via the conda package manager:```bashconda install -c bioconda bowtie2 bwa minimap2 samtools```Alternatively, on ubuntu you can also install them along with additional dependencies through APT:```bashapt-get install bowtie2 bwa minimap2 samtools libbz2-dev liblzma-dev```### Condahicstuff is available as a bioconda package. It can be installed, along with all dependencies using:```bashconda install -c bioconda hicstuff```### DockerA pre-built docker image is made available on quay.io via [biocontainers](https://biocontainers.pro/) and can be ran using:```bashdocker pull quay.io/biocontainers/hicstuff:&lt;tag&gt;```## UsageThe hicstuff command line interface is composed of multiple subcommands. You can always get a summary of all available commands by running:```bashhicstuff --helpSimple Hi-C pipeline for generating and manipulating contact matrices.usage:    hicstuff [-hv] &lt;command&gt; [&lt;args&gt;...]options:    -h, --help                  shows the help    -v, --version               shows the versionThe subcommands are:    convert         Convert Hi-C data between different formats.    digest          Digest genome into a list of fragments.    cutsite         Preprocess fastq files by digesting reads at religation site.    distancelaw     Analyse and plot distance law.    filter          Filters Hi-C pairs to exclude spurious events.    iteralign       Iteratively aligns reads to a reference genome.    missview        Preview missing Hi-C bins in based on the genome and read length.    pipeline        Hi-C pipeline to generate contact matrix from fastq files.    rebin           Bin the matrix and regenerate files accordingly.    subsample       Bootstrap subsampling of contacts from a Hi-C map.    view            Visualize a Hi-C matrix.```### Full pipelineAll components of the pipeline can be run at once using the `hicstuff pipeline` command. This allows to generate a contact matrix from reads in a single command. By default, the output is in GRAAL compatible COO sparse matrix format, but it can be a 2D bedgraph or cool file instead using the `--matfmt` option. More detailed documentation can be found on the readthedocs website: https://hicstuff.readthedocs.io/en/latest/index.html    usage:        pipeline [--aligner=bowtie2] [--centromeres=FILE] [--circular] [--distance-law]                 [--duplicates] [--enzyme=5000] [--filter] [--force] [--mapping=normal]                 [--matfmt=graal] [--no-cleanup] [--outdir=DIR] [--plot] [--prefix=PREFIX]                 [--quality-min=30] [--read-len=INT] [--remove-centromeres=0] [--size=0]                 [--start-stage=fastq] [--threads=1] [--tmpdir=DIR] --genome=FILE &lt;input1&gt; [&lt;input2&gt;]    arguments:        input1:             Forward fastq file, if start_stage is &quot;fastq&quot;, sam                            file for aligned forward reads if start_stage is                            &quot;bam&quot;, or a .pairs file if start_stage is &quot;pairs&quot;.        input2:             Reverse fastq file, if start_stage is &quot;fastq&quot;, sam                            file for aligned reverse reads if start_stage is                            &quot;bam&quot;, or nothing if start_stage is &quot;pairs&quot;.For example, to run the pipeline with minimap2 using 8 threads and generate a matrix in instagraal format in the directory `out`:```hicstuff pipeline -t 8 -a minimap2 -e DpnII -o out/ -g genome.fa reads_for.fq reads_rev.fq```If you have already aligned your reads, hicstuff pipeline can also take bam files as input. For example,to generate a matrix in cool format with a fixed bin size of 5kb:```# Note the bam files have to be name-sorted, this can be done using samtoolssamtools sort -n aligned_for.bam -o namesorted_for.bamsamtools sort -n aligned_rev.bam -o namesorted_rev.bamhicstuff pipeline -S bam -e 5000 -M cool -o out/ -g genome.fa namesorted_for.bam namesorted_rev.bam```The pipeline can also be run from python, using the `hicstuff.pipeline` submodule. For example, this would run the pipeline with bowtie2 (default) using cutsiste alignment and keep all intermediate files. For more examples using the API, see the [API demo](https://hicstuff.readthedocs.io/en/latest/notebooks/demo_api.html)```pythonfrom hicstuff import pipeline as hpihpi.full_pipeline(    'genome.fa',     'end1.fq',     'end2.fq',     no_cleanup=True    mapping='cutsite',    out_dir='out',     enzyme=&quot;DpnII&quot;)```The general steps of the pipeline are as follows:![Pipeline flowchart](doc/images/pipeline.svg)### Individual componentsFor more advanced usage, different scripts can be used independently on the command line to perform individual parts of the pipeline. This readme contains quick descriptions and example usages. To obtain detailed instructions on any subcommand, one can use `hicstuff &lt;subcommand&gt; --help`.### Digestion of the readsGenerates new gzipped fastq files from original fastq. The function will cut the reads at their religation sites and creates new pairs of reads with the different fragments obtained after cutting at the digestion sites.    usage:        cutsite --forward=FILE --reverse=FILE  --prefix=STR --enzyme=STR        [--mode=for_vs_rev] [--seed-size=20] [--threads=1]#### Iterative alignmentTruncate reads from a fastq file to 20 basepairs and iteratively extend and re-align the unmapped reads to optimize the proportion of uniquely aligned reads in a 3C library.    usage:        iteralign [--aligner=bowtie2] [--threads=1] [--min-len=20] [--read-len=INT]                  [--tempdir=DIR] --out-bam=FILE --genome=FILE &lt;reads.fq&gt;#### Digestion of the genomeDigests a fasta file into fragments based on a restriction enzyme or afixed chunk size. Generates two output files into the target directorynamed &quot;info_contigs.txt&quot; and &quot;fragments_list.txt&quot;    usage:        digest [--plot] [--figdir=FILE] [--force] [--circular] [--size=0]               [--outdir=DIR] --enzyme=ENZ &lt;fasta&gt; For example, to digest the yeast genome with MaeII and HinfI and show histogram of fragment lengths:`hicstuff digest --plot --outdir output_dir --enzyme MaeII,HinfI Sc_ref.fa`#### Filtering of 3C eventsFilters spurious 3C events such as loops and uncuts from the library based on a minimum distance threshold automatically estimated from the library by default. Can also plot 3C library statistics. This module takes a pairs file with 9 columns as input (readID, chr1, pos1, chr2, pos2, strand1, strand2, frag1, frag2) and filters it.     usage:        filter [--interactive | --thresholds INT-INT] [--plot]               [--figdir FILE] [--prefix STR] &lt;input&gt; &lt;output&gt;#### Viewing the contact mapVisualize a Hi-C matrix file as a heatmap of contact frequencies. Allows totune visualisation by binning and normalizing the matrix, and to save theoutput image to disk. If no output is specified, the output is displayed.    usage:        view [--binning=1] [--despeckle] [--frags FILE] [--trim INT] [--n-mad 3.0] [--lines]             [--normalize] [--min=0] [--max=99%] [--output=IMG] [--cmap=Reds] [--dpi=300]             [--transform=STR] [--circular] [--region=STR] &lt;contact_map&gt; [&lt;contact_map2&gt;]    arguments:        contact_map             Sparse contact matrix in bg2, cool or graal format        contact_map2            Sparse contact matrix in bg2, cool or graal format,                                if given, the log ratio of contact_map/contact_map2                                will be shown.For example, to view a 1Mb region of chromosome 1 from a full genome Hi-C matrix rebinned at 10kb:```sh    hicstuff view --normalize --binning 10kb --region chr1:10,000,000-11,000,000 --frags fragments_list.txt contact_map.tsv```### LibraryAll components of the hicstuff program can be used as python modules. See the documentation on [reathedocs](https://hicstuff.readthedocs.io). The expected contact map format for the library is a simple CSV file, and the objects handled by the library are simple ```numpy``` arrays. The various submodules of hicstuff contain various utilities.```pythonimport hicstuff.cutsite # Functions to digest fastq librairiesimport hicstuff.digest # Functions to work with restriction fragmentsimport hicstuff.iteralign # Functions related to iterative alignmentimport hicstuff.hicstuff # Contains utilities to modify and operate on contact maps as numpy arraysimport hicstuff.filter # Functions for filtering 3C events by type (uncut, loop)import hicstuff.view # Utilities to visualise contact mapsimport hicstuff.io # Reading and writing hicstuff filesimport hicstuff.pipeline # Generation and processing of files to generate matrices.```### Connecting the modulesAll the steps described here are handled automatically when running the `hicstuff pipeline`. But if you want to connect the different modules manually, the intermediate input and output files can be processed using some python scripting.#### Aligning the readsYou can generate SAM files independently using your favorite read mapping software, use the command line utility `hicstuff iteralign`, or use the helper function `align_reads` in the submodule `hicstuff.pipeline`. For example, to perform iterative alignment using bwa (instead of bowtie2 by default):**Using the python function:**```pythonfrom hicstuff import pipeline as hpihpi.align_reads(&quot;end1.fastq&quot;, &quot;genome.fasta&quot;, &quot;end1.bam&quot;, iterative=True, aligner='bwa')```**Using the command line tool:**```bashhicstuff iteralign --aligner bwa --genome genome.fasta --out-bam end1.bam end1.fastq```#### Extracting contacts from the alignmentThe output from `hicstuff iteralign` is a BAM file. In order to retrieve Hi-C pairs, you need to run iteralign separately on the two fastq files and process the resulting alignment files into a name-sorted BAM file as follows using the `pipeline` submodules of hicstuff.```pythonfrom hicstuff import pipeline as hpiimport pysam as ps# Sort alignments by read names and get into BAM formatps.sort(&quot;-n&quot;, &quot;-O&quot;, &quot;BAM&quot;, &quot;-o&quot;, &quot;end1.bam.sorted&quot;, &quot;end1.bam&quot;)ps.sort(&quot;-n&quot;, &quot;-O&quot;, &quot;BAM&quot;, &quot;-o&quot;, &quot;end2.bam.sorted&quot;, &quot;end2.bam&quot;)# Combine BAM fileshpi.bam2pairs(&quot;end1.sorted.bam&quot;, &quot;end2.sorted.bam&quot;, &quot;output.pairs&quot;, &quot;info_contigs.txt&quot;, min_qual=30)```This will generate a &quot;pairs&quot; file containing all read pairs where both reads have been aligned with a mapping quality of at least 30.#### Attributing each read to a restriction fragmentTo build a a contact matrix, we need to attribute each read to a fragment in the genome. This is done under the hood by performing a binary search for each read position against the list of restriction sites in the genome.```pythonfrom hicstuff import digest as hcdfrom Bio import SeqIO# Build a list of restriction sites for each chromosomerestrict_table = {}for record in SeqIO.parse(&quot;genome.fasta&quot;, &quot;fasta&quot;):    # Get chromosome restriction table    restrict_table[record.id] = hcd.get_restriction_table(        record.seq, enzyme, circular=circular    )# Add fragment index to pairs (readID, chr1, pos1, chr2,# pos2, strand1, strand2, frag1, frag2)hcd.attribute_fragments(&quot;output.pairs&quot;, &quot;output_indexed.pairs&quot;, restrict_table)```#### Filtering pairsThe resulting pairs file can then be filtered, either in the command line using the `hicstuff filter` command, or in python using the `hicstuff.filter` submodule. Otherwise, the matrix can be built directly from the unfiltered pairs. **Filtering on the command line:**```bashhicstuff filter output_indexed.pairs output_filtered.pairs```**Filtering in python:**```pythonfrom hicstuff import filter as hcfuncut_thr, loop_thr = hcf.get_thresholds(&quot;output_indexed.pairs&quot;)hcf.filter_events(&quot;output_indexed.pairs&quot;, &quot;output_filtered.pairs&quot;, uncut_thr, loop_thr)```Note that both the command and the python function have various options to generate figure or tweak the filtering thresholds. These options can be displayed using `hicstuff filter -h`#### Matrix generationA Hi-C sparse contact matrix can then be generated using the python submodule `hicstuff.pipeline`. The matrix can be generated in GRAAL-compatible COO format, bedgraph2 or cool format.```pythonfrom hicstuff import pipeline as hpin_frags = sum(1 for line in open(fragments_list, &quot;r&quot;)) - 1hpi.pairs2matrix(&quot;output_filtered.pairs&quot;, &quot;abs_fragments_contacts_weighted.txt&quot;, 'fragments_list.txt', mat_fmt=&quot;GRAAL&quot;)```### File formats* pairs files: This format is used for all intermediate files in the pipeline and is also used by `hicstuff filter`. It is a tab-separated format holding informations about Hi-C pairs. It has an [official specification](https://github.com/4dn-dcic/pairix/blob/master/pairs_format_specification.md) defined by the 4D Nucleome data coordination and integration center.* 2D bedgraph: This is an optional output format of `hicstuff pipeline` for the sparse matrix. It has two fragment per line, and the number of times they are found together. It has the following fields: **chr1, start1, end1, chr2, start2, end2, occurences**    - Those files can be [loaded by cooler](https://cooler.readthedocs.io/en/latest/cli.html?highlight=load#cooler-load) using `cooler load -f bg2 &lt;chrom.sizes&gt;:&lt;binsize&gt; in.bg2.gz out.cool` where chrom.sizes is a tab delimited file with chromosome names and length on each line, and binsize is the size of bins in the matrix.* GRAAL sparse matrix: This is a simple tab-separated file with 3 columns: **frag1, frag2, contacts**. The id columns correspond to the absolute id of the restriction fragments (0-indexed). The first row is a header containing the number of rows, number of columns and number of nonzero entries in the matrix. Example:```5645646978003124133```* fragments_list.txt: This tab separated file provides information about restriction fragments positions, size and GC content. Note the coordinates are 0 point basepairs, unlike the pairs format, which has 1 point basepairs. Example:   - id: 1 based restriction fragment index within chromosome.   - chrom: Chromosome identifier. Order should be the same as in info_contigs.txt or pairs files.   - start_pos: 0-based start of fragment, in base pairs.   - end_pos: 0-based end of fragment, in base pairs.   - size: Size of fragment, in base pairs.   - gc_content: Proportion of G and C nucleotide in the fragment.```idchromstart_posend_possizegc_content1seq1021210.52380952380952382seq12180590.5762711864406783seq1803282480.5201612903225806```* info_contigs.txt: This tab separated file gives information on contigs, such as number of restriction fragments and size. Example:   - contig: Chromosome identified. Order should be the same in pairs files or fragments_list.txt.   - length: Chromosome length, in base pairs.   - n_frags: Number of restriction fragments in chromosome.   - cumul_length: Cumulative length of previous chromosome, in base pairs.```contiglengthn_fragscumul_lengthseq1600004090seq220000155409```### ContributingAll contributions are welcome, in the form of bug reports, suggestions, documentation or pull requests.We use the [numpy standard](https://numpydoc.readthedocs.io/en/latest/format.html) for docstrings when documenting functions.The code formatting standard we use is [black](https://github.com/psf/black), with --line-length=79 to follow PEP8 recommendations. We use `pytest` with the `pytest-doctest` and `pytest-pylint` plugins as our testing framework. Ideally, new functions should have associated unit tests, placed in the `tests` folder.To test the code, you can run:```bashpytest --doctest-modules --pylint --pylint-error-types=EF --pylint-rcfile=.pylintrc hicstuff tests```### CitationPlease cite hicstuff using the official DOI as follows:Cyril Matthey-Doret, Lyam Baudry, Amaury Bignaud, Axel Cournac, Remi-Montagne, Nadège Guiglielmoni, Théo Foutel Rodier and Vittore F. Scolari. 2020. hicstuff: Simple library/pipeline to generate and handle Hi-C data . Zenodo. http://doi.org/10.5281/zenodo.4066363Bibtex entry:```@software{cyril_matthey_doret_2020_4066351,  author       = {Cyril Matthey-Doret and                  Lyam Baudry and                  Amaury Bignaud and                  Axel Cournac and                  Remi-Montagne and                  Nadège Guiglielmoni and                  Théo Foutel-Rodier and                  Vittore F. Scolari},  title        = {hicstuff: Simple library/pipeline to generate and handle Hi-C data },  month        = oct,  year         = 2020,  publisher    = {Zenodo},  version      = {v2.3.1},  doi          = {10.5281/zenodo.4066351},  url          = {http://doi.org/10.5281/zenodo.4066363}}```</longdescription>
</pkgmetadata>